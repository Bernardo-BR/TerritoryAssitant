<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Designar Mapas - SUNRISE</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>


    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        body {
            font-family: 'Poppins', sans-serif;
        }
        .modal-backdrop { transition: opacity 0.3s ease; }
        .modal-content { transition: transform 0.3s ease; }
        /* Estilos para a aba ativa */
        .tab-active {
            border-color: #3b82f6; /* blue-500 */
            color: #3b82f6;
        }

        /* Responsividade para o cabeçalho em telas pequenas */
        @media (max-width: 640px) { /* sm breakpoint */
            header .container {
                flex-direction: column; /* Empilha logo e título verticalmente */
                align-items: center;
                text-align: center;
                padding-top: 1rem; /* Adiciona um pouco de padding superior */
                padding-bottom: 1rem; /* Adiciona um pouco de padding inferior */
            }
            header h2 {
                font-size: 1.5rem; /* Tamanho do título menor */
                margin-top: 0.5rem; /* Espaçamento entre logo e título */
            }
            header img {
                height: 2.5rem; /* Reduz o tamanho do logo */
            }
        }

        /* Responsividade para o seletor de semana */
        @media (max-width: 640px) { /* sm breakpoint */
            #week-selector-container {
                flex-direction: row; /* Mantém em linha, mas pode ajustar espaçamento */
                padding-left: 1rem;
                padding-right: 1rem;
                gap: 0.5rem; /* Reduz o espaçamento entre os elementos */
            }
            #week-display {
                width: auto; /* Deixa a largura automática */
                flex-grow: 1; /* Permite que ocupe o espaço disponível */
            }
            #week-display span {
                font-size: 0.875rem; /* text-sm */
            }
            #prev-week-btn, #next-week-btn {
                padding: 0.5rem; /* Reduz o padding dos botões */
            }
        }

        /* Responsividade para as abas */
        @media (max-width: 640px) { /* sm breakpoint */
            .border-b {
                overflow-x: auto; /* Permite rolagem horizontal se as abas não couberem */
                -webkit-overflow-scrolling: touch; /* Melhor rolagem em iOS */
            }
            .border-b nav {
                flex-wrap: nowrap; /* Impede que as abas quebrem para a próxima linha */
                padding-left: 1rem;
                padding-right: 1rem;
            }
            .tab-btn {
                font-size: 0.875rem; /* text-sm */
                padding-left: 0.5rem;
                padding-right: 0.5rem;
                white-space: nowrap; /* Garante que o texto da aba não quebre */
            }
        }

        /* Responsividade para o conteúdo principal */
        @media (max-width: 640px) { /* sm breakpoint */
            main.container {
                padding-left: 1rem;
                padding-right: 1rem;
            }
            #days-container {
                grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); /* Ajusta para 1 coluna ou 2 dependendo do espaço */
            }
            .day-btn h3 {
                font-size: 1.5rem; /* Tamanho da fonte menor para o dia */
            }
            /* Ajustes para itens de lista em Registro e Status */
            .assignment-item, .status-item, .report-item-btn { /* classes não presentes diretamente no HTML, mas representam a estrutura de lista */
                flex-direction: column; /* Empilha itens em telas pequenas */
                align-items: flex-start;
                gap: 0.5rem;
            }
            .assignment-item .flex.items-center.gap-2 { /* Botões de ação em Registro */
                width: 100%;
                justify-content: space-around; /* Distribui os botões */
            }
            #print-report-btn {
                width: 100%; /* Botão de relatório ocupa a largura total */
                justify-content: center;
            }

            .report-item-btn {
                text-align: left;
            }
            .report-item-btn span {
                width: 100%;
                text-align: left;
            }
            .report-item-btn svg {
                position: absolute;
                right: 1rem;
            }
        }

        /* Ajustes para modais */
        .modal-content {
            width: 90%; /* Largura máxima em telas menores */
            max-width: 28rem; /* max-w-sm */
        }
        @media (min-width: 768px) { /* md breakpoint */
            .modal-content {
                max-width: 32rem; /* max-w-md */
            }
        }
        @media (min-width: 1024px) { /* lg breakpoint */
            .modal-content {
                max-width: 42rem; /* max-w-lg */
            }
        }
    </style>
</head>
<body class="bg-gray-100">

    <div id="main-content">
        <header class="bg-white shadow-md">
            <div class="container mx-auto px-6 py-4 flex justify-between items-center">
                <a href="dashboard.html" title="Voltar para o Dashboard">
                    <img src="https://i.ibb.co/8gwxJtRG/SUNRISE-1.png" alt="SUNRISE Logo" class="h-12 w-auto">
                </a>
                <h2 class="text-2xl font-semibold text-gray-700">Designar Mapas para Saída</h2>
            </div>
        </header>

        <div id="week-selector-container" class="container mx-auto px-6 mt-8 flex justify-center items-center gap-4">
            <button id="prev-week-btn" class="p-2 rounded-full bg-white shadow hover:bg-gray-100 transition-colors">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7" />
                </svg>
            </button>
            <div id="week-display" class="flex flex-col items-center text-center font-semibold text-gray-700 w-48">
                </div>
            <button id="next-week-btn" class="p-2 rounded-full bg-white shadow hover:bg-gray-100 transition-colors">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7" />
                </svg>
            </button>
        </div>

        <div class="container mx-auto px-6 mt-6">
            <div class="border-b border-gray-200">
                <nav class="-mb-px flex space-x-8" aria-label="Tabs">
                    <button id="tab-designar" class="tab-btn tab-active whitespace-nowrap py-4 px-1 border-b-2 font-medium text-lg">
                        Designar
                    </button>
                    <button id="tab-registro" class="tab-btn text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-lg">
                        Registro
                    </button>
                    <button id="tab-status" class="tab-btn text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-lg">
                        Status
                    </button>
                    <button id="tab-relatorio" class="tab-btn text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-lg">
                        Relatório
                    </button>
                </nav>
            </div>
        </div>

        <main class="container mx-auto px-6 py-12">
            <div id="designar-content">
                <div id="days-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6"></div>
            </div>
            <div id="registro-content" class="hidden"><div id="assignments-list" class="space-y-4"></div></div>
            <div id="status-content" class="hidden">
                <div class="mb-8">
                    <h3 class="text-2xl font-bold text-gray-800 mb-4">Resumo dos Territórios</h3>
                    <div id="territory-summary-list" class="space-y-3"></div>
                </div>
                <div>
                    <h3 class="text-2xl font-bold text-gray-800 mb-4">Status dos Mapas Individuais</h3>
                    <div id="status-list" class="space-y-2"></div>
                </div>
            </div>
            <div id="relatorio-content" class="hidden">
                 <div class="flex justify-end mb-4">
                    <button id="print-report-btn" class="flex items-center gap-2 px-4 py-2 bg-gray-600 text-white rounded-md hover:bg-gray-700 transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                          <path fill-rule="evenodd" d="M5 4v3H4a2 2 0 00-2 2v6a2 2 0 002 2h12a2 2 0 002-2V9a2 2 0 00-2-2h-1V4a2 2 0 00-2-2H7a2 2 0 00-2 2zm8 0H7v3h6V4zm0 8H7v4h6v-4z" clip-rule="evenodd" />
                        </svg>
                        Imprimir Relatório
                    </button>
                </div>
                <div id="report-list" class="space-y-2"></div>
            </div>
        </main>
    </div>

    <div id="location-modal" class="fixed inset-0 z-[1050] flex items-center justify-center bg-black bg-opacity-50 backdrop-blur-sm hidden"></div>
    <div id="map-list-modal" class="fixed inset-0 z-[1050] flex items-center justify-center bg-black bg-opacity-50 backdrop-blur-sm hidden"></div>
    <div id="confirm-modal" class="fixed inset-0 z-[1050] flex items-center justify-center bg-black bg-opacity-50 backdrop-blur-sm hidden"></div>
    <div id="alert-modal" class="fixed inset-0 z-[1050] flex items-center justify-center bg-black bg-opacity-50 backdrop-blur-sm hidden"></div>
    <div id="cycle-select-modal" class="fixed inset-0 z-[1050] flex items-center justify-center bg-black bg-opacity-50 backdrop-blur-sm hidden"></div>
    <div id="date-edit-modal" class="fixed inset-0 z-[1050] flex items-center justify-center bg-black bg-opacity-50 backdrop-blur-sm hidden"></div>
    <div id="toast-container" class="fixed top-5 right-5 z-[2000] space-y-2"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.19.1/firebase-app.js";
        import { getFirestore, collection, getDocs, onSnapshot, addDoc, doc, updateDoc, deleteDoc, query, where, orderBy, Timestamp } from "https://www.gstatic.com/firebasejs/9.19.1/firebase-firestore.js";

        const { jsPDF } = window.jspdf;

        const firebaseConfig = {
            apiKey: "AIzaSyCpeqeg5OULEivfWeft_B47h2XiRtn75B8",
            authDomain: "meu-app-de-mapas-c4d00.firebaseapp.com",
            projectId: "meu-app-de-mapas-c4d00",
            storageBucket: "meu-app-de-mapas-c4d00.appspot.com",
            messagingSenderId: "544761751470",
            appId: "1:544761751470:web:646dcfef9745bfd77b8a3f",
            measurementId: "G-LDX3H58RT5"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        let allSubmaps = [], assignmentsForWeek = [], allAssignments = [];
        let currentWeekStart = getWeekStartDate(new Date());
        let unsubscribeAssignments = () => {}, unsubscribeAllAssignments = () => {}, unsubscribeLocations = () => {};
        let fieldLocations = {};

        const daysContainer = document.getElementById('days-container');
        const locationModalEl = document.getElementById('location-modal');
        const mapListModalEl = document.getElementById('map-list-modal');
        const confirmModalEl = document.getElementById('confirm-modal');
        const alertModalEl = document.getElementById('alert-modal');
        const cycleSelectModalEl = document.getElementById('cycle-select-modal');
        const dateEditModalEl = document.getElementById('date-edit-modal');

        function getWeekStartDate(d) {
            const date = new Date(d);
            const day = date.getDay();
            const diff = date.getDate() - day + (day === 0 ? -6 : 1);
            date.setHours(0, 0, 0, 0);
            date.setDate(diff);
            return date;
        }

        function formatDate(date) {
            if (!date) return 'N/A';
            const jsDate = date.toDate ? date.toDate() : date;
            if (isNaN(jsDate.getTime())) return 'N/A';
            return jsDate.toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit', year: 'numeric' });
        }
        
        function dateToInputFormat(date) {
            if (!date) return '';
            const jsDate = date.toDate ? date.toDate() : date;
            if (isNaN(jsDate.getTime())) return '';
            const year = jsDate.getFullYear();
            const month = String(jsDate.getMonth() + 1).padStart(2, '0');
            const day = String(jsDate.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        function updateWeekDisplay() {
            const weekStart = new Date(currentWeekStart);
            const weekEnd = new Date(weekStart);
            weekEnd.setDate(weekEnd.getDate() + 6);
            document.getElementById('week-display').innerHTML = `<span class="text-lg sm:text-xl">${formatDate(weekStart)}</span><span class="text-xs text-gray-500">a</span><span class="text-lg sm:text-xl">${formatDate(weekEnd)}</span>`;
        }

        function showAlert(message) {
            alertModalEl.innerHTML = `<div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-sm modal-content"><p class="text-center text-gray-700">${message}</p><button id="alert-close-btn" class="mt-4 w-full bg-blue-500 text-white py-2 rounded-md hover:bg-blue-600">OK</button></div>`;
            alertModalEl.classList.remove('hidden');
            document.getElementById('alert-close-btn').onclick = () => alertModalEl.classList.add('hidden');
        }
        
        function showToast(message) {
            const toastContainer = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = 'bg-yellow-400 text-yellow-800 font-bold p-4 rounded-lg shadow-lg animate-pulse';
            toast.textContent = message;
            toastContainer.appendChild(toast);
            setTimeout(() => {
                toast.remove();
            }, 5000);
        }

        function showLocationModal(day, locations) {
            let buttonsHtml = locations.map(location => `<button class="location-btn w-full px-4 py-3 mb-3 font-semibold text-white bg-gray-700 rounded-lg hover:bg-gray-800" data-day="${day}" data-location="${location}">${location}</button>`).join('');
            locationModalEl.innerHTML = `<div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-sm modal-content"><h3 class="text-lg font-semibold mb-4 text-center">Escolha o Local para ${day}</h3>${buttonsHtml}<button id="location-cancel-btn" class="mt-2 w-full text-gray-600 py-2 rounded-md hover:bg-gray-200">Cancelar</button></div>`;
            locationModalEl.classList.remove('hidden');
            document.getElementById('location-cancel-btn').onclick = () => locationModalEl.classList.add('hidden');
            document.querySelectorAll('.location-btn').forEach(btn => btn.onclick = () => {
                locationModalEl.classList.add('hidden');
                showMapListModal(day, btn.dataset.location);
            });
        }

        function showMapListModal(day, location, editingAssignment = null) {
            const concludedSubmapIds = new Set(allAssignments.filter(a => a.status === 'concluido').map(a => a.submapId));
            const availableMaps = allSubmaps.filter(sm => !concludedSubmapIds.has(sm.id));
            let mapsHtml = availableMaps.length > 0 ? availableMaps.map(sm => `<li class="map-item p-3 hover:bg-blue-50 rounded-md cursor-pointer" data-submap-id="${sm.id}" data-submap-name="${sm.name}">${sm.name} (${sm.territoryName})</li>`).join('') : `<li class="p-3 text-center text-gray-500">Nenhum mapa disponível.</li>`;
            const title = editingAssignment ? `Editando Mapa para ${day} - ${location}` : `Selecione um Mapa para ${day} - ${location}`;
            mapListModalEl.innerHTML = `<div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-lg modal-content"><h3 class="text-lg font-semibold mb-4">${title}</h3><ul class="max-h-80 overflow-y-auto">${mapsHtml}</ul><button id="map-list-cancel-btn" class="mt-4 w-full text-gray-600 py-2 rounded-md hover:bg-gray-200">Cancelar</button></div>`;
            mapListModalEl.classList.remove('hidden');
            document.getElementById('map-list-cancel-btn').onclick = () => mapListModalEl.classList.add('hidden');
            document.querySelectorAll('.map-item').forEach(item => item.onclick = () => {
                mapListModalEl.classList.add('hidden');
                showConfirmModal(day, location, item.dataset.submapId, item.dataset.submapName, editingAssignment);
            });
        }

        function showConfirmModal(day, location, submapId, submapName, editingAssignment = null) {
            const title = editingAssignment ? 'Confirmar Edição' : 'Confirmar Designação';
            confirmModalEl.innerHTML = `<div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-sm modal-content"><h3 class="text-lg font-semibold mb-2">${title}</h3><p>Dia: <span class="font-medium">${day}</span></p><p>Local: <span class="font-medium">${location}</span></p><p>Mapa: <span class="font-medium">${submapName}</span></p><div class="flex justify-end gap-3 mt-6"><button id="confirm-cancel-btn" class="px-4 py-2 bg-gray-200 rounded-md">Cancelar</button><button id="confirm-send-btn" class="px-4 py-2 bg-blue-500 text-white rounded-md">Confirmar</button></div></div>`;
            confirmModalEl.classList.remove('hidden');
            document.getElementById('confirm-cancel-btn').onclick = () => confirmModalEl.classList.add('hidden');
            document.getElementById('confirm-send-btn').onclick = async () => {
                if (editingAssignment) await updateAssignment(editingAssignment.id, submapId, submapName);
                else await assignMap(day, location, submapId, submapName);
                confirmModalEl.classList.add('hidden');
            };
        }
        
        function showDeleteConfirmModal(message, onConfirm) {
            confirmModalEl.innerHTML = `<div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-sm modal-content"><p class="text-center">${message}</p><div class="flex justify-end gap-3 mt-4"><button id="confirm-cancel" class="px-4 py-2 bg-gray-200 rounded-md">Cancelar</button><button id="confirm-delete" class="px-4 py-2 bg-red-500 text-white rounded-md">Excluir</button></div></div>`;
            confirmModalEl.classList.remove('hidden');
            document.getElementById('confirm-cancel').onclick = () => confirmModalEl.classList.add('hidden');
            document.getElementById('confirm-delete').onclick = () => {
                onConfirm();
                confirmModalEl.classList.add('hidden');
            };
        }

        async function assignMap(day, location, submapId, submapName) {
            const isAlreadyAssigned = allAssignments.some(a => a.submapId === submapId && a.status !== 'concluido' && a.status !== 'arquivado');
            if (isAlreadyAssigned) {
                showToast("Mapa duplicado, confira se está correto.");
            }

            const weekStartString = currentWeekStart.toISOString().split('T')[0];
            try {
                await addDoc(collection(db, "assignments"), {
                    dayOfWeek: day, location, submapId, submapName, 
                    assignedAt: new Date(), weekStart: weekStartString, status: 'pendente', completedAt: null, cycle: 0
                });
                showAlert(`Mapa "${submapName}" designado com sucesso!`);
            } catch (error) { console.error("Erro ao designar mapa: ", error); showAlert("Ocorreu um erro."); }
        }

        async function updateAssignment(assignmentId, newSubmapId, newSubmapName) {
            try {
                await updateDoc(doc(db, "assignments", assignmentId), { submapId: newSubmapId, submapName: newSubmapName });
                showAlert(`Designação atualizada com sucesso!`);
            } catch (error) { console.error("Erro ao atualizar: ", error); showAlert("Ocorreu um erro."); }
        }

        async function deleteAssignment(assignmentId, submapName) {
            showDeleteConfirmModal(`Excluir a designação do mapa "${submapName}"?`, async () => {
                 try {
                    await deleteDoc(doc(db, "assignments", assignmentId));
                    showAlert(`Designação do mapa "${submapName}" excluída.`);
                } catch (error) { console.error("Erro ao excluir: ", error); showAlert("Ocorreu um erro."); }
            });
        }
        
        async function handleRegistryStatusChange(assignmentId, newStatus) {
            const assignmentRef = doc(db, "assignments", assignmentId);
            const updateData = { status: newStatus };
            if (newStatus === 'concluido') {
                updateData.completedAt = new Date();
            }
            await updateDoc(assignmentRef, updateData);
        }

        async function handleResetTerritory(territoryId) {
            const submapsInTerritory = allSubmaps.filter(sm => sm.territoryId === territoryId);
            const submapIdsInTerritory = submapsInTerritory.map(sm => sm.id);
            
            const assignmentsToArchive = allAssignments.filter(a => 
                submapIdsInTerritory.includes(a.submapId) && a.status === 'concluido'
            );

            if (assignmentsToArchive.length === 0) {
                showAlert("Este território não possui mapas concluídos para reiniciar.");
                return;
            }

            const maxCycle = Math.max(0, ...assignmentsToArchive.map(a => a.cycle || 0));
            const newCycle = maxCycle + 1;

            const archivePromises = assignmentsToArchive.map(a => updateDoc(doc(db, "assignments", a.id), { 
                status: 'arquivado',
                cycle: newCycle
            }));
            await Promise.all(archivePromises);
            showAlert("Território reiniciado com sucesso! Os mapas estão disponíveis novamente.");
        }

        async function fetchAllSubmaps() {
            const territoriesSnapshot = await getDocs(query(collection(db, "territories")));
            const submapPromises = territoriesSnapshot.docs.map(tDoc => 
                getDocs(collection(db, "territories", tDoc.id, "submaps")).then(sSnap => 
                    sSnap.docs.map(sDoc => ({ id: sDoc.id, territoryId: tDoc.id, territoryName: tDoc.data().name, ...sDoc.data() }))
                )
            );
            const submapArrays = await Promise.all(submapPromises);
            allSubmaps = submapArrays.flat().sort((a, b) => a.name.localeCompare(b.name, undefined, { numeric: true }));
        }

        function listenForAssignmentsForWeek() {
            unsubscribeAssignments();
            const weekStartString = currentWeekStart.toISOString().split('T')[0];
            const assignmentsQuery = query(collection(db, "assignments"), where("weekStart", "==", weekStartString));
            unsubscribeAssignments = onSnapshot(assignmentsQuery, (snapshot) => {
                assignmentsForWeek = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
                renderAssignmentsList();
            });
        }

        function listenForAllAssignments() {
            unsubscribeAllAssignments();
            const allAssignmentsQuery = query(collection(db, "assignments"), orderBy("assignedAt", "desc"));
            unsubscribeAllAssignments = onSnapshot(allAssignmentsQuery, (snapshot) => {
                allAssignments = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
                renderCurrentVisibleDynamicTab();
            });
        }
        
        function listenForFieldLocations() {
            unsubscribeLocations();
            const locationsColRef = collection(db, "fieldLocations");
            unsubscribeLocations = onSnapshot(locationsColRef, (snapshot) => {
                const newLocations = {};
                snapshot.forEach(doc => {
                    newLocations[doc.id] = doc.data().locations || [];
                });
                fieldLocations = newLocations;
                renderDayButtons(); 
            });
        }

        function renderCurrentVisibleDynamicTab() {
            if (!document.getElementById('status-content').classList.contains('hidden')) {
                renderStatusList();
                renderTerritorySummary();
            }
            if (!document.getElementById('relatorio-content').classList.contains('hidden')) {
                renderReportList();
            }
        }

        function renderDayButtons() {
            daysContainer.innerHTML = '';
            const weekOrder = ["SEGUNDA", "TERÇA", "QUARTA", "QUINTA", "SEXTA", "SÁBADO", "DOMINGO"];
            weekOrder.forEach(day => {
                const button = document.createElement('button');
                button.className = "day-btn p-6 bg-white rounded-lg shadow hover:shadow-lg transition-all duration-300 transform hover:-translate-y-1";
                button.dataset.day = day;
                button.innerHTML = `<h3 class="text-2xl font-bold text-gray-800">${day}</h3>`;
                button.onclick = () => {
                    const locations = fieldLocations[day] || [];
                    if (locations.length === 0) {
                        showAlert(`Nenhum local de saída definido para ${day}. Adicione um na página de edição.`);
                    } else if (locations.length === 1) {
                        showMapListModal(day, locations[0]);
                    } else {
                        showLocationModal(day, locations);
                    }
                };
                daysContainer.appendChild(button);
            });
        }

        function renderAssignmentsList() {
            const listEl = document.getElementById('assignments-list');
            listEl.innerHTML = '';

            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const actualCurrentWeekStart = getWeekStartDate(today);
            const diffDays = (currentWeekStart.getTime() - actualCurrentWeekStart.getTime()) / (1000 * 60 * 60 * 24);

            if (diffDays === 7) {
                const dayOrder = { "DOMINGO": 0, "SEGUNDA": 1, "TERÇA": 2, "QUARTA": 3, "QUINTA": 4, "SEXTA": 5, "SÁBADO": 6 };
                const todayDayIndex = today.getDay();

                const previewMaps = allAssignments.filter(a => {
                    const assignmentWeekStart = getWeekStartDate(a.assignedAt.toDate());
                    const isCurrentWeek = assignmentWeekStart.getTime() === actualCurrentWeekStart.getTime();
                    const dayHasPassed = dayOrder[a.dayOfWeek] < todayDayIndex;
                    return isCurrentWeek && a.status === 'trabalhando' && dayHasPassed;
                }).sort((a, b) => dayOrder[a.dayOfWeek] - dayOrder[b.dayOfWeek]);

                if (previewMaps.length > 0) {
                    const previewContainer = document.createElement('div');
                    previewContainer.className = 'mb-6';
                    previewContainer.innerHTML = `<h4 class="text-lg font-semibold text-gray-500 mb-2 italic">Preview de Mapas a Serem Reagendados:</h4>`;
                    const previewList = document.createElement('div');
                    previewList.className = 'space-y-2 p-4 bg-gray-50 rounded-lg';
                    
                    previewMaps.forEach(a => {
                        const itemEl = document.createElement('div');
                        itemEl.className = 'italic text-gray-500 p-2';
                        itemEl.innerHTML = `<span>${a.dayOfWeek}: ${a.submapName} (${a.location})</span>`;
                        previewList.appendChild(itemEl);
                    });

                    previewContainer.appendChild(previewList);
                    listEl.appendChild(previewContainer);
                }
            }

            if (assignmentsForWeek.length === 0) {
                if (listEl.innerHTML === '') {
                    listEl.innerHTML = '<p class="text-center text-gray-500">Nenhum mapa designado para esta semana.</p>';
                }
                return;
            }

            const groupedByDay = assignmentsForWeek.reduce((acc, a) => {
                if (!acc[a.dayOfWeek]) acc[a.dayOfWeek] = [];
                acc[a.dayOfWeek].push(a);
                return acc;
            }, {});

            const weekOrder = ["SEGUNDA", "TERÇA", "QUARTA", "QUINTA", "SEXTA", "SÁBADO", "DOMINGO"];
            weekOrder.forEach(day => {
                if (groupedByDay[day]) {
                    const dayGroupEl = document.createElement('div');
                    dayGroupEl.className = 'bg-white p-4 rounded-lg shadow';
                    dayGroupEl.innerHTML = `<h3 class="text-xl font-bold text-gray-800 mb-3">${day}</h3>`;
                    const assignmentList = document.createElement('ul');
                    assignmentList.className = 'space-y-2';
                    groupedByDay[day].forEach(a => {
                        const itemEl = document.createElement('li');
                        itemEl.className = 'flex flex-col sm:flex-row justify-between items-start sm:items-center p-2 rounded-md hover:bg-gray-50 assignment-item'; // Added assignment-item class and flex-col
                        
                        let statusButtonHtml = '';
                        if (a.status === 'pendente') {
                            statusButtonHtml = `<button class="start-assignment-btn px-3 py-1 text-sm font-medium text-green-600 bg-green-100 rounded-full hover:bg-green-200" data-id="${a.id}">Iniciar</button>`;
                        } else if (a.status === 'trabalhando') {
                            statusButtonHtml = `<button class="finish-assignment-btn px-3 py-1 text-sm font-medium text-red-600 bg-red-100 rounded-full hover:bg-red-200" data-id="${a.id}">Concluir</button>`;
                        } else {
                            statusButtonHtml = `<span class="px-3 py-1 text-sm font-medium text-gray-600 bg-gray-100 rounded-full">Finalizado</span>`;
                        }

                        itemEl.innerHTML = `
                            <div class="mb-2 sm:mb-0"> <span class="font-semibold">${a.location}:</span>
                                <span class="text-gray-700 ml-2">${a.submapName}</span>
                            </div>
                            <div class="flex items-center gap-2 w-full sm:w-auto justify-end"> ${statusButtonHtml}
                                <button class="edit-assignment-btn p-1 text-gray-400 hover:text-blue-500 rounded-full" title="Editar Designação">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828zM5 12V7a2 2 0 012-2h2.586l-4.293 4.293A2 2 0 015 12z" /></svg>
                                </button>
                                <button class="delete-assignment-btn p-1 text-gray-400 hover:text-red-500 rounded-full" title="Excluir Designação">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd" /></svg>
                                </button>
                            </div>
                        `;
                        assignmentList.appendChild(itemEl);
                        itemEl.querySelector('.edit-assignment-btn').onclick = () => showMapListModal(a.dayOfWeek, a.location, a);
                        itemEl.querySelector('.delete-assignment-btn').onclick = () => deleteAssignment(a.id, a.submapName);
                        
                        const startBtn = itemEl.querySelector('.start-assignment-btn');
                        if (startBtn) startBtn.onclick = () => handleRegistryStatusChange(a.id, 'trabalhando');
                        
                        const finishBtn = itemEl.querySelector('.finish-assignment-btn');
                        if (finishBtn) finishBtn.onclick = () => handleRegistryStatusChange(a.id, 'concluido');
                    });
                    dayGroupEl.appendChild(assignmentList);
                    listEl.appendChild(dayGroupEl);
                }
            });
        }

        function renderStatusList() {
            const listEl = document.getElementById('status-list');
            listEl.innerHTML = '';
            const submapStatusMap = new Map();
            allAssignments.forEach(a => {
                if (!submapStatusMap.has(a.submapId) || (a.status !== 'pendente' && a.status !== 'arquivado')) {
                    submapStatusMap.set(a.submapId, a.status);
                }
            });
            allSubmaps.forEach(submap => {
                const status = submapStatusMap.get(submap.id) || 'nao_iniciado';
                let statusText, statusColorClass;
                switch(status) {
                    case 'trabalhando': statusText = 'Em andamento'; statusColorClass = 'bg-yellow-400'; break;
                    case 'concluido': statusText = 'Concluído'; statusColorClass = 'bg-green-400'; break;
                    default: statusText = 'Não iniciado'; statusColorClass = 'bg-red-400'; break;
                }
                const itemEl = document.createElement('div');
                itemEl.className = 'bg-white p-3 rounded-lg shadow-sm flex flex-col sm:flex-row justify-between items-start sm:items-center status-item'; // Added status-item and flex-col
                itemEl.innerHTML = `<div><p class="font-semibold">${submap.name}</p><p class="text-sm text-gray-500">${submap.territoryName}</p></div><div class="flex items-center gap-2 mt-2 sm:mt-0"><span class="w-3 h-3 rounded-full ${statusColorClass}"></span><span class="text-sm font-medium">${statusText}</span></div>`;
                listEl.appendChild(itemEl);
            });
        }

        function renderTerritorySummary() {
            const summaryListEl = document.getElementById('territory-summary-list');
            if (!summaryListEl) return;
            summaryListEl.innerHTML = '';

            const submapStatusMap = new Map();
            allAssignments.forEach(a => {
                if (!submapStatusMap.has(a.submapId) || (a.status !== 'pendente' && a.status !== 'arquivado')) {
                    submapStatusMap.set(a.submapId, a.status);
                }
            });

            const submapsByTerritory = allSubmaps.reduce((acc, submap) => {
                const territoryId = submap.territoryId;
                if (!acc[territoryId]) {
                    acc[territoryId] = { name: submap.territoryName, submaps: [] };
                }
                acc[territoryId].submaps.push(submap);
                return acc;
            }, {});

            Object.values(submapsByTerritory).sort((a,b) => a.name.localeCompare(b.name)).forEach(territory => {
                const totalMaps = territory.submaps.length;
                let completedMaps = 0;
                let inProgressMaps = 0;

                territory.submaps.forEach(submap => {
                    const status = submapStatusMap.get(submap.id);
                    if (status === 'concluido') completedMaps++;
                    else if (status === 'trabalhando') inProgressMaps++;
                });

                let territoryStatusText, territoryStatusColor, resetButtonHtml = '';
                if (totalMaps > 0 && completedMaps === totalMaps) {
                    territoryStatusText = 'Concluído'; territoryStatusColor = 'bg-green-400';
                    resetButtonHtml = `<button class="reset-territory-btn text-xs text-blue-500 hover:underline" data-territory-id="${territory.submaps[0].territoryId}">Reiniciar</button>`;
                } else if (inProgressMaps > 0 || completedMaps > 0) {
                    territoryStatusText = 'Em andamento'; territoryStatusColor = 'bg-yellow-400';
                } else {
                    territoryStatusText = 'Não iniciado'; territoryStatusColor = 'bg-red-400';
                }

                const itemEl = document.createElement('div');
                itemEl.className = 'bg-white p-4 rounded-lg shadow-sm grid grid-cols-1 sm:grid-cols-3 gap-4 items-center text-center'; // Adjusted grid for small screens
                itemEl.innerHTML = `
                    <p class="font-bold text-gray-800 text-left sm:col-span-1">${territory.name}</p>
                    <div class="flex justify-center items-center gap-2 sm:col-span-1">
                        <span class="w-3 h-3 rounded-full ${territoryStatusColor}"></span>
                        <span class="font-medium text-gray-700">${territoryStatusText}</span>
                    </div>
                    <div class="flex justify-center items-center gap-4 sm:col-span-1">
                        <p class="font-semibold text-gray-600">${completedMaps} / ${totalMaps}</p>
                        ${resetButtonHtml}
                    </div>
                `;
                summaryListEl.appendChild(itemEl);
            });

            document.querySelectorAll('.reset-territory-btn').forEach(btn => {
                btn.onclick = () => handleResetTerritory(btn.dataset.territoryId);
            });
        }

        function renderReportList() {
            const listEl = document.getElementById('report-list');
            listEl.innerHTML = '';
            const assignmentsBySubmap = allAssignments.reduce((acc, a) => {
                if (!acc[a.submapId]) acc[a.submapId] = { name: a.submapName, history: [] };
                acc[a.submapId].history.push(a);
                return acc;
            }, {});
            allSubmaps.forEach(submap => {
                const detailsId = `details-${submap.id}`;
                const itemEl = document.createElement('div');
                itemEl.className = 'bg-white rounded-lg shadow-sm';
                itemEl.innerHTML = `<button class="w-full text-left p-4 flex justify-between items-center report-item-btn"><span class="font-semibold">${submap.name}</span><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 transition-transform" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" /></svg></button><div id="${detailsId}" class="hidden p-4 border-t overflow-x-auto"></div>`; // Added overflow-x-auto for table
                listEl.appendChild(itemEl);
                itemEl.querySelector('.report-item-btn').addEventListener('click', (e) => {
                    const detailsEl = document.getElementById(detailsId);
                    const icon = e.currentTarget.querySelector('svg');
                    const isHidden = detailsEl.classList.toggle('hidden');
                    icon.classList.toggle('rotate-180', !isHidden);
                    if (!isHidden) {
                        const data = assignmentsBySubmap[submap.id];
                        if (data && data.history.length > 0) {
                            let tableHtml = `<table class="w-full text-sm text-left whitespace-nowrap"><thead><tr class="bg-gray-50"><th class="px-4 py-2">Ciclo</th><th class="px-4 py-2">Início</th><th class="px-4 py-2">Término</th><th class="px-4 py-2">Duração</th><th class="px-4 py-2">Ações</th></tr></thead><tbody>`;
                            let completedCount = 0;
                            data.history.forEach(h => {
                                if (h.status === 'arquivado' || h.status === 'concluido') {
                                    completedCount++;
                                }
                                const startDate = h.assignedAt ? h.assignedAt.toDate() : null;
                                const endDate = h.completedAt ? h.completedAt.toDate() : null;
                                let duration = 'Em andamento';
                                if (startDate && endDate) {
                                    const diffTime = Math.abs(endDate - startDate);
                                    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                                    duration = `${diffDays} dia(s)`;
                                } else if (h.status === 'concluido') {
                                    duration = 'Finalizado';
                                }
                                tableHtml += `<tr class="border-b">
                                    <td class="px-4 py-2">${completedCount}ª Vez</td>
                                    <td class="px-4 py-2">${formatDate(h.assignedAt)}</td>
                                    <td class="px-4 py-2">${formatDate(h.completedAt)}</td>
                                    <td class="px-4 py-2">${duration}</td>
                                    <td class="px-4 py-2"><button class="edit-history-btn text-blue-500 hover:underline" data-id="${h.id}">Editar</button></td>
                                </tr>`;
                            });
                            tableHtml += `</tbody></table>`;
                            detailsEl.innerHTML = tableHtml;

                            detailsEl.querySelectorAll('.edit-history-btn').forEach(btn => {
                                btn.onclick = () => {
                                    const historyItem = data.history.find(h => h.id === btn.dataset.id);
                                    showDateEditModal(historyItem);
                                };
                            });
                        } else {
                            detailsEl.innerHTML = `<p class="text-gray-500">Nenhum histórico.</p>`;
                        }
                    }
                });
            });
        }

        async function reassignUnfinishedMaps() {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const currentWeekStartString = getWeekStartDate(today).toISOString().split('T')[0];

            const q = query(collection(db, "assignments"), where("weekStart", "<", currentWeekStartString));
            const snapshot = await getDocs(q);

            const reassignPromises = [];
            snapshot.forEach(docSnap => {
                const assignment = docSnap.data();
                if (assignment.status !== 'concluido' && assignment.status !== 'arquivado') {
                    const newAssignmentData = {
                        ...assignment,
                        weekStart: currentWeekStartString,
                        status: 'pendente',
                        assignedAt: new Date(),
                        completedAt: null
                    };
                    reassignPromises.push(addDoc(collection(db, "assignments"), newAssignmentData));
                    reassignPromises.push(deleteDoc(docSnap.ref));
                }
            });

            if (reassignPromises.length > 0) {
                await Promise.all(reassignPromises);
                const numReassigned = reassignPromises.length / 2;
                if (numReassigned > 0) {
                    showAlert(`${numReassigned} mapa(s) não concluído(s) foram reagendados para a semana atual.`);
                }
            }
        }
        
        function showCycleSelectModal() {
            const territoriesWithHistory = allSubmaps.reduce((acc, submap) => {
                if (!acc[submap.territoryId]) {
                    acc[submap.territoryId] = { name: submap.territoryName, cycles: new Set() };
                }
                const history = allAssignments.filter(a => a.submapId === submap.id && (a.status === 'concluido' || a.status === 'arquivado'));
                history.forEach(h => acc[submap.territoryId].cycles.add(h.cycle || 1));
                return acc;
            }, {});

            let territoryOptions = Object.entries(territoriesWithHistory).map(([id, data]) => `<option value="${id}">${data.name}</option>`).join('');

            cycleSelectModalEl.innerHTML = `
                <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-sm modal-content">
                    <h3 class="text-lg font-semibold mb-4">Gerar Relatório</h3>
                    <div class="space-y-4">
                        <select id="report-territory-select" class="w-full border p-2 rounded-md"><option value="">Selecione um Território</option>${territoryOptions}</select>
                        <select id="report-cycle-select" class="w-full border p-2 rounded-md" disabled><option value="">Selecione o Ciclo</option></select>
                    </div>
                    <div class="flex justify-end gap-3 mt-6">
                        <button id="cycle-cancel-btn" class="px-4 py-2 bg-gray-200 rounded-md">Cancelar</button>
                        <button id="cycle-confirm-btn" class="px-4 py-2 bg-blue-500 text-white rounded-md" disabled>Imprimir</button>
                    </div>
                </div>
            `;
            cycleSelectModalEl.classList.remove('hidden');

            const territorySelect = document.getElementById('report-territory-select');
            const cycleSelect = document.getElementById('report-cycle-select');
            const confirmBtn = document.getElementById('cycle-confirm-btn');

            territorySelect.onchange = () => {
                const territoryId = territorySelect.value;
                cycleSelect.innerHTML = '<option value="">Selecione o Ciclo</option>';
                cycleSelect.disabled = true;
                confirmBtn.disabled = true;

                if (territoryId) {
                    const cycles = Array.from(territoriesWithHistory[territoryId].cycles).sort((a,b) => a-b);
                    cycleSelect.innerHTML += cycles.map(c => `<option value="${c}">${c}ª Vez Concluído</option>`).join('');
                    cycleSelect.disabled = false;
                }
            };

            cycleSelect.onchange = () => {
                confirmBtn.disabled = !cycleSelect.value;
            };

            document.getElementById('cycle-cancel-btn').onclick = () => cycleSelectModalEl.classList.add('hidden');
            confirmBtn.onclick = () => {
                const territoryId = territorySelect.value;
                const territoryName = territorySelect.options[territorySelect.selectedIndex].text;
                const cycle = parseInt(cycleSelect.value);
                generateReportPDF(territoryId, territoryName, cycle);
                cycleSelectModalEl.classList.add('hidden');
            };
        }

        function generateReportPDF(territoryId, territoryName, cycle) {
            const doc = new jsPDF();
            const submapIdsInTerritory = allSubmaps.filter(sm => sm.territoryId === territoryId).map(sm => sm.id);
            const cycleAssignments = allAssignments.filter(a => submapIdsInTerritory.includes(a.submapId) && a.cycle === cycle);
            
            if(cycleAssignments.length === 0) {
                showAlert("Nenhum dado encontrado para este ciclo.");
                return;
            }

            const startDates = cycleAssignments.map(a => a.assignedAt.toDate()).filter(Boolean);
            const endDates = cycleAssignments.map(a => a.completedAt?.toDate()).filter(Boolean);
            const overallStart = startDates.length ? new Date(Math.min.apply(null, startDates)) : null;
            const overallEnd = endDates.length ? new Date(Math.max.apply(null, endDates)) : null;

            doc.setFontSize(18);
            doc.text(`Relatório do Território: ${territoryName}`, 14, 22);
            doc.setFontSize(12);
            doc.text(`Ciclo de Trabalho: ${cycle}ª Vez Concluído`, 14, 30);
            doc.text(`Período: ${formatDate(overallStart)} a ${formatDate(overallEnd)}`, 14, 38);

            const tableData = cycleAssignments.map(a => {
                return [a.submapName, formatDate(a.completedAt)];
            });

            doc.autoTable({
                startY: 50,
                head: [['Mapa', 'Data de Conclusão']],
                body: tableData,
            });

            doc.save(`Relatorio_${territoryName}_Ciclo_${cycle}.pdf`);
        }

        function showDateEditModal(assignment) {
            dateEditModalEl.innerHTML = `
                <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-sm modal-content">
                    <h3 class="text-lg font-semibold mb-4">Editar Datas - ${assignment.submapName}</h3>
                    <div class="space-y-4">
                        <div>
                            <label for="edit-start-date" class="block text-sm font-medium text-gray-700">Data de Início</label>
                            <input type="date" id="edit-start-date" value="${dateToInputFormat(assignment.assignedAt)}" class="mt-1 w-full border border-gray-300 p-2 rounded-md">
                        </div>
                        <div>
                            <label for="edit-end-date" class="block text-sm font-medium text-gray-700">Data de Término</label>
                            <input type="date" id="edit-end-date" value="${dateToInputFormat(assignment.completedAt)}" class="mt-1 w-full border border-gray-300 p-2 rounded-md">
                        </div>
                    </div>
                    <div class="flex justify-end gap-3 mt-6">
                        <button id="date-edit-cancel-btn" class="px-4 py-2 bg-gray-200 rounded-md">Cancelar</button>
                        <button id="date-edit-confirm-btn" class="px-4 py-2 bg-blue-500 text-white rounded-md">Salvar</button>
                    </div>
                </div>
            `;
            dateEditModalEl.classList.remove('hidden');

            document.getElementById('date-edit-cancel-btn').onclick = () => dateEditModalEl.classList.add('hidden');
            document.getElementById('date-edit-confirm-btn').onclick = async () => {
                const newStartDate = document.getElementById('edit-start-date').value;
                const newEndDate = document.getElementById('edit-end-date').value;
                
                const updateData = {};
                if (newStartDate) updateData.assignedAt = Timestamp.fromDate(new Date(newStartDate));
                if (newEndDate) updateData.completedAt = Timestamp.fromDate(new Date(newEndDate));

                if (Object.keys(updateData).length > 0) {
                    await updateDoc(doc(db, "assignments", assignment.id), updateData);
                    showAlert("Datas atualizadas com sucesso!");
                }
                dateEditModalEl.classList.add('hidden');
            };
        }
        
        function setupTabs() {
            const tabs = document.querySelectorAll('.tab-btn');
            const contents = {
                'tab-designar': document.getElementById('designar-content'),
                'tab-registro': document.getElementById('registro-content'),
                'tab-status': document.getElementById('status-content'),
                'tab-relatorio': document.getElementById('relatorio-content'),
            };
            const weekSelector = document.getElementById('week-selector-container');
            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    tabs.forEach(t => t.classList.remove('tab-active'));
                    Object.values(contents).forEach(c => c.classList.add('hidden'));
                    tab.classList.add('tab-active');
                    contents[tab.id].classList.remove('hidden');
                    if (tab.id === 'tab-designar' || tab.id === 'tab-registro') {
                        weekSelector.classList.remove('hidden');
                        weekSelector.classList.add('flex');
                    } else {
                        weekSelector.classList.add('hidden');
                        weekSelector.classList.remove('flex');
                    }
                    renderCurrentVisibleDynamicTab();
                });
            });
        }
        
        window.onload = async () => {
            setupTabs();
            listenForFieldLocations();
            updateWeekDisplay();
            
            await reassignUnfinishedMaps();
            await fetchAllSubmaps();
            listenForAssignmentsForWeek();
            listenForAllAssignments();
            
            document.getElementById('prev-week-btn').addEventListener('click', () => {
                currentWeekStart.setDate(currentWeekStart.getDate() - 7);
                updateWeekDisplay();
                listenForAssignmentsForWeek();
            });
            document.getElementById('next-week-btn').addEventListener('click', () => {
                currentWeekStart.setDate(currentWeekStart.getDate() + 7);
                updateWeekDisplay();
                listenForAssignmentsForWeek();
            });
            document.getElementById('print-report-btn').addEventListener('click', showCycleSelectModal);
        };
    </script>
</body>
</html>